#include <YSI\YSI_Coding\y_hooks>

stock Player::SaveData(playerid)
{
    new query[256], DBResult:db_result, name[MAX_PLAYER_NAME];

    GetPlayerName(playerid, name);

    format(query, sizeof(query), "SELECT * FROM `players` WHERE `name` = '%q' LIMIT 1", name);

    db_result = DB_ExecuteQuery(db_handle, query);

    if(DB_GetRowCount(db_result))
    {
        DB_FreeResultSet(db_result);

        format(query, sizeof(query), "UPDATE `players` \
        SET pass = '%q', payday_tstamp = %i, bitcoin = %i, money = %i, \
        pX = %f, pY = %f, pZ = %f, pA = %f, score = %i, \
        skinid = %i, orgid = %i \
        WHERE name = '%q';",
        Player[playerid][pyr::pass], Player[playerid][pyr::payday_tstamp], 
        Player[playerid][pyr::bitcoin], Player[playerid][pyr::money], 
        Player[playerid][pyr::pX], Player[playerid][pyr::pY], Player[playerid][pyr::pZ], 
        Player[playerid][pyr::pA], Player[playerid][pyr::score],
        Player[playerid][pyr::skinid], Player[playerid][pyr::orgid], name);

        DB_FreeResultSet(DB_ExecuteQuery(db_handle, query));
    }

    else
    {
        DB_FreeResultSet(db_result);

        format(query, sizeof(query), "INSERT INTO `players` (\
        name, pass, payday_tstamp, bitcoin, money, pX, pY, pZ, pA, score, skinid, orgid) \
        VALUES('%q', '%q', %i, %i, %i, %f, %f, %f, %f, %i, %i, %i);",
        name, Player[playerid][pyr::pass], Player[playerid][pyr::payday_tstamp], Player[playerid][pyr::bitcoin], 
        Player[playerid][pyr::money], Player[playerid][pyr::pX], Player[playerid][pyr::pY], 
        Player[playerid][pyr::pZ],  Player[playerid][pyr::pA],
        Player[playerid][pyr::score], Player[playerid][pyr::skinid], Player[playerid][pyr::orgid]);

        DB_FreeResultSet(DB_ExecuteQuery(db_handle, query));

        printf("[ DB (PLAYER) ] Conta do jogador %s, adicionada ao banco", name);
    }
}

stock Player::LoadIntData(playerid, const field[])
{
    new query[256], DBResult:db_result, name[MAX_PLAYER_NAME];

    GetPlayerName(playerid, name);

    format(query, sizeof(query), "SELECT * FROM `players` WHERE `name` = '%s' LIMIT 1", name);

    db_result = DB_ExecuteQuery(db_handle, query);

    if(!DB_GetRowCount(db_result))
    {
        DB_FreeResultSet(db_result);
        return 0;
    }

    new result;
    result = DB_GetFieldIntByName(db_result, field); 
    DB_FreeResultSet(db_result);

    return result;
}

stock Float:Player::LoadIntData(playerid, const field[])
{
    new query[256], DBResult:db_result, name[MAX_PLAYER_NAME];

    GetPlayerName(playerid, name);

    format(query, sizeof(query), "SELECT * FROM `players` WHERE `name` = '%s' LIMIT 1", name);

    db_result = DB_ExecuteQuery(db_handle, query);

    if(!DB_GetRowCount(db_result))
    {
        DB_FreeResultSet(db_result);
        return 0;
    }

    new Float:result;
    result = DB_GetFieldFloatByName(db_result, field); 
    DB_FreeResultSet(db_result);

    return result;
}

stock Player::LoadStrData(playerid, const field[], result[])
{
    new query[256], DBResult:db_result, name[MAX_PLAYER_NAME];

    GetPlayerName(playerid, name);

    format(query, sizeof(query), "SELECT * FROM `players` WHERE `name` = '%s' LIMIT 1", name);

    db_result = DB_ExecuteQuery(db_handle, query);

    if(!DB_GetRowCount(db_result))
    {
        DB_FreeResultSet(db_result);
        return 0;
    }

    DB_GetFieldStringByName(db_result, field, result);
    DB_FreeResultSet(db_result);

    return 1;
}


stock Player::LoadAllData(playerid)
{
    new query[256], DBResult:db_result, name[MAX_PLAYER_NAME];

    GetPlayerName(playerid, name);

    format(query, sizeof(query), "SELECT * FROM `players` WHERE `name` = '%s' LIMIT 1", name);

    db_result = DB_ExecuteQuery(db_handle, query);

    if(!DB_GetRowCount(db_result))
    {
        DB_FreeResultSet(db_result);
        return 0;
    }

    DB_GetFieldStringByName(db_result, "pass", Player[playerid][pyr::pass]); DB_GetFieldStringByName(db_result, "pass", Player[playerid][pyr::pass]);
    Player[playerid][pyr::payday_tstamp]    = DB_GetFieldIntByName(db_result, "payday_tstamp"); 
    Player[playerid][pyr::bitcoin]          = DB_GetFieldIntByName(db_result, "bitcoin"); 
    Player[playerid][pyr::money]            = DB_GetFieldFloatByName(db_result, "money");  
    Player[playerid][pyr::score]            = DB_GetFieldIntByName(db_result, "score"); 
    Player[playerid][pyr::skinid]           = DB_GetFieldIntByName(db_result, "skinid"); 
    Player[playerid][pyr::orgid]            = DB_GetFieldIntByName(db_result, "orgid"); 

    DB_FreeResultSet(db_result);
  
    return 1;
}

//////////////////////////////////////////////////////////////////////////////////////////////                                                             
/*                                          BANIDOS                                         */
////////////////////////////////////////////////////////////////////////////////////////////// 

stock Player::SaveBanData(const name[], const ip[], const reason[], const admin[], level, left_time)
{
    new query[256], DBResult:db_result;

    format(query, sizeof(query), "SELECT * FROM `player_punisheds` WHERE `name` = '%q' LIMIT 1", name);

    db_result = DB_ExecuteQuery(db_handle, query);

    if(DB_GetRowCount(db_result))
    {
        DB_FreeResultSet(db_result);

        format(query, sizeof(query), "UPDATE `player_punisheds` \
        SET level = '%i', left_tstamp = %i, \
        WHERE name = '%q';", level, left_time, name);

        DB_FreeResultSet(DB_ExecuteQuery(db_handle, query));
    }

    else
    {
        DB_FreeResultSet(db_result);

        format(query, sizeof(query), "INSERT INTO `player_punisheds` (\
        name, ip, punished_by, level, reason, left_tstamp) \
        VALUES('%q', '%q', '%q', %i, '%q', %i);",
        name, ip, admin, level, reason, left_time);

        DB_FreeResultSet(DB_ExecuteQuery(db_handle, query));

        printf("[ DB (BANIDOS) ] Jogador %s, adicionado à tabela de banidos\n", name);
    }    
}

stock Player::VerifyPunish(const name[], ip[16], reason[64], admin[24], &level, &left_time, &is_pardon)
{
    new query[256], DBResult:db_result;

    format(query, sizeof(query), "SELECT * FROM `player_punisheds` WHERE `name` = '%q' LIMIT 1", name);

    db_result = DB_ExecuteQuery(db_handle, query);

    if(!DB_GetRowCount(db_result))
    {
        DB_FreeResultSet(db_result);
        return 0;
    }

    DB_GetFieldStringByName(db_result, "ip", ip);
    DB_GetFieldStringByName(db_result, "reason", reason);
    DB_GetFieldStringByName(db_result, "punished_by", admin);
    level      = DB_GetFieldIntByName(db_result, "level"); 
    left_time  = DB_GetFieldIntByName(db_result, "left_tstamp");
    is_pardon  = 0;

    DB_FreeResultSet(db_result);

    if(left_time == -1)
        return 1;
        
    if(gettime() > left_time)
    {
        format(query, sizeof(query), "DELETE FROM `player_punisheds` WHERE `name` = '%q'", name);
        DB_FreeResultSet(DB_ExecuteQuery(db_handle, query));
        is_pardon = 1;
        printf("[ DB (BANIDOS) ] O jogador %s foi removido da lista de banidos, banimento expirou!", name);
        return 1;
    }

    return 1;
}

//////////////////////////////////////////////////////////////////////////////////////////////                                                             
/*                                          ACESSORY                                        */
////////////////////////////////////////////////////////////////////////////////////////////// 

stock Acessory::SaveAllSlotsData(playerid, slotid)
{
    for(new i = 0; i < MAX_ACESSORYS; i++)
        Acessory::SaveSlotData(playerid, i);
}

stock Acessory::LoadAllSlotsData(playerid, slotid)
{
    for(new i = 0; i < MAX_ACESSORYS; i++)
        Acessory::LoadSlotData(playerid, i);
}

stock Acessory::SaveSlotData(playerid, slotid)
{
    new query[256], DBResult:db_result, name[MAX_PLAYER_NAME];

    GetPlayerName(playerid, name);

    format(query, sizeof(query), "SELECT * FROM `player_acessorys` \
    WHERE `owner` = '%q' AND slotid = %i LIMIT 1", name, slotid);

    db_result = DB_ExecuteQuery(db_handle, query);

    if(DB_GetRowCount(db_result))
    {
        DB_FreeResultSet(db_result);

        format(query, sizeof(query), "UPDATE `player_acessorys` \
        SET modelid = %i, boneid = %i, \
        pX = %f, pY = %f, pZ = %f \
        rX = %f, rY = %f, rZ = %f \
        sX = %f, sY = %f, sZ = %f \
        WHERE `owner` = '%q' AND slotid = %i;",
        acs::Player[playerid][slotid][acs::modelid],
        acs::Player[playerid][slotid][acs::boneid],
        acs::Player[playerid][slotid][acs::pX], acs::Player[playerid][slotid][acs::pY], acs::Player[playerid][slotid][acs::pZ],
        acs::Player[playerid][slotid][acs::rX], acs::Player[playerid][slotid][acs::rY], acs::Player[playerid][slotid][acs::rZ],
        acs::Player[playerid][slotid][acs::sX], acs::Player[playerid][slotid][acs::sY], acs::Player[playerid][slotid][acs::sZ],
        name, slotid);

        DB_FreeResultSet(DB_ExecuteQuery(db_handle, query));
    }

    else
    {
        DB_FreeResultSet(db_result);

        format(query, sizeof(query), "INSERT INTO `player_acessorys` (\
        owner, slotid, modelid, boneid, \
        pX, pY, pZ, \
        rX, rY, rZ, \
        sX, sY, sZ) \
        VALUES('%q', '%i', %i, '%i', %f, %f, %f, %f, %f, %f, %f, %f, %f);",
        name, slotid, acs::Player[playerid][slotid][acs::modelid], acs::Player[playerid][slotid][acs::boneid],
        acs::Player[playerid][slotid][acs::pX], acs::Player[playerid][slotid][acs::pY], acs::Player[playerid][slotid][acs::pZ],
        acs::Player[playerid][slotid][acs::rX], acs::Player[playerid][slotid][acs::rY], acs::Player[playerid][slotid][acs::rZ],
        acs::Player[playerid][slotid][acs::sX], acs::Player[playerid][slotid][acs::sY], acs::Player[playerid][slotid][acs::sZ]
        );

        DB_FreeResultSet(DB_ExecuteQuery(db_handle, query));

        printf("[ DB (ACESSORY) ] Acessório #%d do jogador %s, adicionada ao banco", slotid, name);
    }
}

stock Acessory::LoadSlotData(playerid, slotid)
{
    new query[256], DBResult:db_result, name[MAX_PLAYER_NAME];

    GetPlayerName(playerid, name);

    format(query, sizeof(query), "SELECT * FROM `player_acessorys` \
    WHERE `owner` = '%q' AND slotid = %i LIMIT 1", name, slotid);

    db_result = DB_ExecuteQuery(db_handle, query);

    if(!DB_GetRowCount(db_result))
    {
        DB_FreeResultSet(db_result);
        return 0;
    }

    acs::Player[playerid][slotid][acs::modelid] = DB_GetFieldIntByName(db_result, "modelid"); 
    acs::Player[playerid][slotid][acs::boneid]  = DB_GetFieldIntByName(db_result, "boneid"); 
    acs::Player[playerid][slotid][acs::pX]      = DB_GetFieldFloatByName(db_result, "pX"); 
    acs::Player[playerid][slotid][acs::pY]      = DB_GetFieldFloatByName(db_result, "pY"); 
    acs::Player[playerid][slotid][acs::pZ]      = DB_GetFieldFloatByName(db_result, "pZ"); 
    acs::Player[playerid][slotid][acs::rX]      = DB_GetFieldFloatByName(db_result, "rX"); 
    acs::Player[playerid][slotid][acs::rY]      = DB_GetFieldFloatByName(db_result, "rY"); 
    acs::Player[playerid][slotid][acs::rZ]      = DB_GetFieldFloatByName(db_result, "rZ"); 
    acs::Player[playerid][slotid][acs::sX]      = DB_GetFieldFloatByName(db_result, "sX"); 
    acs::Player[playerid][slotid][acs::sY]      = DB_GetFieldFloatByName(db_result, "sY"); 
    acs::Player[playerid][slotid][acs::sZ]      = DB_GetFieldFloatByName(db_result, "sZ"); 

    DB_FreeResultSet(db_result);
  
    return 1;
}

//////////////////////////////////////////////////////////////////////////////////////////////                                                             
/*                                          VEHICLES                                        */
////////////////////////////////////////////////////////////////////////////////////////////// 

stock Vehicle::SaveSlotData(playerid, slotid)
{
    new query[256], DBResult:db_result, name[MAX_PLAYER_NAME];

    GetPlayerName(playerid, name);
    
    format(query, sizeof(query), "SELECT * FROM `player_vehicles` \
    WHERE `owner` = '%q' AND slotid = %i LIMIT 1", name, slotid);

    db_result = DB_ExecuteQuery(db_handle, query);

    if(DB_GetRowCount(db_result))
    {
        DB_FreeResultSet(db_result);

        format(query, sizeof(query), "UPDATE `player_vehicles` \
        SET modelid = %i, \
        pX = %f, pY = %f, pZ = %f, pA = %f\
        color1 = %i, color2 = %i \
        WHERE `owner` = '%q' AND slotid = %i;",
        veh::Player[playerid][slotid][veh::modelid], veh::Player[playerid][slotid][veh::pX], 
        veh::Player[playerid][slotid][veh::pY], veh::Player[playerid][slotid][veh::pZ],
        veh::Player[playerid][slotid][veh::pA], veh::Player[playerid][slotid][veh::color1], 
        veh::Player[playerid][slotid][veh::color2], name, slotid);

        DB_FreeResultSet(DB_ExecuteQuery(db_handle, query));
    }

    else
    {
        DB_FreeResultSet(db_result);

        format(query, sizeof(query), "INSERT INTO `player_vehicles` (\
        owner, slotid, modelid, \
        pX, pY, pZ, pA, \
        color1, color2) \
        VALUES('%q', '%i', %i, '%f', %f, %f, %f, %i, %i);",
        name, slotid, veh::Player[playerid][slotid][veh::modelid], 
        veh::Player[playerid][slotid][veh::pX], veh::Player[playerid][slotid][veh::pY], 
        veh::Player[playerid][slotid][veh::pZ], veh::Player[playerid][slotid][veh::pA], 
        veh::Player[playerid][slotid][veh::color1], veh::Player[playerid][slotid][veh::color2]
        );

        DB_FreeResultSet(DB_ExecuteQuery(db_handle, query));

        printf("[ DB (VEHICLE) ] Veículo #%d do jogador %s, adicionada ao banco", slotid, name);
    }    
}

stock Vehicle::LoadSlotData(playerid, slotid)
{
    new query[256], DBResult:db_result, name[MAX_PLAYER_NAME];

    GetPlayerName(playerid, name);

    format(query, sizeof(query), "SELECT * FROM `player_vehicles` \
    WHERE `owner` = '%q' AND slotid = %i LIMIT 1", name, slotid);

    db_result = DB_ExecuteQuery(db_handle, query);

    if(!DB_GetRowCount(db_result))
    {
        DB_FreeResultSet(db_result);
        return 0;
    }

    veh::Player[playerid][slotid][veh::modelid] = DB_GetFieldIntByName(db_result, "modelid"); 
    veh::Player[playerid][slotid][veh::pX]      = DB_GetFieldFloatByName(db_result, "pX"); 
    veh::Player[playerid][slotid][veh::pY]      = DB_GetFieldFloatByName(db_result, "pY"); 
    veh::Player[playerid][slotid][veh::pZ]      = DB_GetFieldFloatByName(db_result, "pZ"); 
    veh::Player[playerid][slotid][veh::pA]      = DB_GetFieldFloatByName(db_result, "pA"); 
    veh::Player[playerid][slotid][veh::color1]  = DB_GetFieldIntByName(db_result, "color1"); 
    veh::Player[playerid][slotid][veh::color2]  = DB_GetFieldIntByName(db_result, "color2"); 

    DB_FreeResultSet(db_result);
  
    return 1;
}